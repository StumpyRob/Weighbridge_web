{% extends "base.html" %}

{% block title %}Edit Ticket {{ ticket.ticket_no }} | Weighbridge Web{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Ticket {{ ticket.ticket_no }}</h1>
    <p class="muted">Edit ticket details and status.</p>
  </div>
  <div class="actions">
    {% if ticket.status == "OPEN" %}
      <button type="submit" class="button" form="ticket-form" name="action" value="complete">
        Mark Complete
      </button>
    {% endif %}
  </div>
</div>

{% if invoice %}
  <div class="audit">
    <div>
      <strong>Invoiced on:</strong>
      <a href="/invoices/{{ invoice.id }}">{{ invoice.invoice_no }}</a>
    </div>
  </div>
{% endif %}

<div class="audit">
  <div><strong>Created:</strong> {{ ticket.created_at.strftime("%d/%m/%Y %H:%M") if ticket.created_at else "" }}</div>
  <div><strong>Updated:</strong> {{ ticket.updated_at.strftime("%d/%m/%Y %H:%M") if ticket.updated_at else "" }}</div>
</div>

{% if completed or saved %}
  <div class="alert alert-success" data-auto-dismiss>
    {{ "Ticket completed." if completed else "Saved." }}
  </div>
  <script>
    if (window.history && window.history.replaceState) {
      window.history.replaceState({}, "", window.location.pathname);
    }
    window.setTimeout(function () {
      const banner = document.querySelector("[data-auto-dismiss]");
      if (banner) {
        banner.remove();
      }
    }, 3000);
  </script>
{% endif %}

{% if errors %}
  <div class="alert">
    <ul>
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<div id="mismatch-warning">
  {% if direction_warning %}
    {% include "tickets/_mismatch_warning.html" %}
  {% endif %}
</div>

<div id="weight-warning">
{% if weight_warning %}
  <div class="alert">
    Gross is lower than Tare - use Swap Weights.
  </div>
{% endif %}
</div>

<form id="ticket-form" class="ticket-form" method="post" action="/tickets/{{ ticket.id }}">
  {% if ticket.status in ["COMPLETE", "VOID"] %}
    <div class="alert">
      This ticket is locked.
    </div>
  {% endif %}

  <fieldset {% if ticket.status in ["COMPLETE", "VOID"] %}disabled{% endif %}>
  <section class="card">
    <h2>Ticket Info</h2>
    <div class="form-grid">
      <div class="field">
        <label for="datetime">Date/time</label>
        <input type="datetime-local" id="datetime" name="datetime" value="{{ form.datetime }}" required />
      </div>
      <div class="field">
        <label for="direction">Direction</label>
        <select
          id="direction"
          name="direction"
          required
          hx-get="/tickets/mismatch-warning"
          hx-trigger="change"
          hx-target="#mismatch-warning"
          hx-include="#direction,#transaction_type"
        >
          <option value="">Select direction</option>
          {% for value in enums.directions %}
            <option value="{{ value }}" {% if form.direction|string == value|string %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="transaction_type">Transaction type</label>
        <select
          id="transaction_type"
          name="transaction_type"
          required
          hx-get="/tickets/mismatch-warning"
          hx-trigger="change"
          hx-target="#mismatch-warning"
          hx-include="#direction,#transaction_type"
        >
          <option value="">Select transaction</option>
          {% for value in enums.transaction_types %}
            <option value="{{ value }}" {% if form.transaction_type|string == value|string %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Status</label>
        <input
          type="text"
          class="status-input status-{{ form.status | lower }}"
          value="{{ form.status }}"
          readonly
        />
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Parties</h2>
    <p class="help">If you select a vehicle with an owner set, the customer will default automatically.</p>
    <div class="form-grid">
      <div class="field">
        <label for="customer_id">Customer</label>
        <select id="customer_id" name="customer_id">
          <option value="">Select customer</option>
          {% for id, label in options.customers %}
            <option value="{{ id }}" {% if form.customer_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="vehicle_id">Vehicle</label>
        <select id="vehicle_id" name="vehicle_id">
          <option value="">Select vehicle</option>
          {% for id, label in options.vehicles %}
            <option value="{{ id }}" {% if form.vehicle_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="product_id">Product</label>
        <select
          id="product_id"
          name="product_id"
          hx-get="/tickets/product-defaults"
          hx-trigger="change"
          hx-target="#pricing-defaults"
          hx-include="[name='unit_price'],[name='unit_id'],[name='product_id']"
        >
          <option value="">Select product</option>
          {% for id, label in options.products %}
            <option value="{{ id }}" {% if form.product_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Optional Lookups</h2>
    <div class="form-grid">
      <div class="field">
        <label for="haulier_id">Haulier</label>
        <select id="haulier_id" name="haulier_id">
          <option value="">Select haulier</option>
          {% for id, label in options.hauliers %}
            <option value="{{ id }}" {% if form.haulier_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="driver_id">Driver</label>
        <select id="driver_id" name="driver_id">
          <option value="">Select driver</option>
          {% for id, label in options.drivers %}
            <option value="{{ id }}" {% if form.driver_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="container_id">Container</label>
        <select id="container_id" name="container_id">
          <option value="">Select container</option>
          {% for id, label in options.containers %}
            <option value="{{ id }}" {% if form.container_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="destination_id">Destination</label>
        <select id="destination_id" name="destination_id">
          <option value="">Select destination</option>
          {% for id, label in options.destinations %}
            <option value="{{ id }}" {% if form.destination_id|string == id|string %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="yard_id">Yard <span class="muted">TODO: Not wired yet</span></label>
        <input type="hidden" name="yard_id" value="{{ form.yard_id }}" />
        <input type="text" value="TODO: Not wired yet" disabled />
      </div>
      <div class="field">
        <label for="area_id">Area <span class="muted">TODO: Not wired yet</span></label>
        <input type="hidden" name="area_id" value="{{ form.area_id }}" />
        <input type="text" value="TODO: Not wired yet" disabled />
      </div>
      <div class="field">
        <label for="waste_code_id">Waste code <span class="muted">TODO: Not wired yet</span></label>
        <input type="hidden" name="waste_code_id" value="{{ form.waste_code_id }}" />
        <input type="text" value="TODO: Not wired yet" disabled />
      </div>
      <div class="field">
        <label for="waste_producer_id">Waste producer <span class="muted">TODO: Not wired yet</span></label>
        <input type="hidden" name="waste_producer_id" value="{{ form.waste_producer_id }}" />
        <input type="text" value="TODO: Not wired yet" disabled />
      </div>
      <div class="field">
        <label for="licence_id">Licence <span class="muted">TODO: Not wired yet</span></label>
        <input type="hidden" name="licence_id" value="{{ form.licence_id }}" />
        <input type="text" value="TODO: Not wired yet" disabled />
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Weights</h2>
    <div id="weights-block">
      {% set show_weight_errors = false %}
      {% include "tickets/_weights_block.html" %}
    </div>
  </section>

  <section class="card">
    <h2>Pricing</h2>
    <div class="form-grid">
      <div class="field">
        <label for="qty">Quantity</label>
        <input type="number" step="0.001" id="qty" name="qty" value="{{ form.qty }}" />
      </div>
      <div id="pricing-defaults">
        {% with units=options.units, unit_id=form.unit_id, unit_price=form.unit_price %}
          {% include "tickets/_pricing_defaults.html" %}
        {% endwith %}
      </div>
      <div class="field">
        <label for="total">Total</label>
        <input
          type="text"
          id="total"
          name="total"
          value="{{ form.total }}"
          placeholder="â€”"
          readonly
        />
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Flags</h2>
    <div class="field checkbox">
      <input type="checkbox" id="dont_invoice" name="dont_invoice" {% if form.dont_invoice %}checked{% endif %} />
      <label for="dont_invoice">Don't invoice</label>
    </div>
  </section>
  </fieldset>

  <div class="actions">
    {% if ticket.status not in ["COMPLETE", "VOID"] %}
      <button type="submit" name="action" value="save">Save</button>
    {% endif %}
    <a class="link-button" href="/tickets">Cancel</a>
  </div>
</form>

<section class="card">
  <h2>Void Ticket</h2>
  <form method="post" action="/tickets/{{ ticket.id }}">
    <input type="hidden" name="action" value="void" />
    <div class="form-grid">
      <div class="field">
        <label for="void_reason_id">Void reason</label>
        <select id="void_reason_id" name="void_reason_id">
          <option value="">Select reason</option>
          {% for id, label in options.void_reasons %}
            <option value="{{ id }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label for="void_note">Note</label>
        <input type="text" id="void_note" name="void_note" />
      </div>
    </div>
    <div class="actions">
      {% if ticket.status != "VOID" %}
        <button type="submit" class="danger">Void Ticket</button>
      {% endif %}
    </div>
  </form>
</section>

<script>
  (function () {
    function parseNumber(value) {
      const parsed = parseFloat(value);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function bindCalculations() {
      const grossInput = document.getElementById("gross_kg");
      const tareInput = document.getElementById("tare_kg");
      const netInput = document.getElementById("net_kg");
      const qtyInput = document.getElementById("qty");
      const unitPriceInput = document.getElementById("unit_price");
      const totalInput = document.getElementById("total");

      function updateNet() {
        if (!netInput) {
          return;
        }
        const gross = parseNumber(grossInput && grossInput.value);
        const tare = parseNumber(tareInput && tareInput.value);
        if (gross === null || tare === null) {
          netInput.value = "";
          return;
        }
        netInput.value = String(Math.round(gross - tare));
      }

      function updateTotal() {
        if (!totalInput) {
          return;
        }
        const qty = parseNumber(qtyInput && qtyInput.value);
        const unitPrice = parseNumber(unitPriceInput && unitPriceInput.value);
        if (qty === null || unitPrice === null) {
          totalInput.value = "";
          return;
        }
        totalInput.value = (qty * unitPrice).toFixed(2);
      }

      if (grossInput && tareInput && grossInput.dataset.netBound !== "true") {
        grossInput.dataset.netBound = "true";
        tareInput.dataset.netBound = "true";
        grossInput.addEventListener("input", updateNet);
        tareInput.addEventListener("input", updateNet);
      }
      if (qtyInput && unitPriceInput && qtyInput.dataset.totalBound !== "true") {
        qtyInput.dataset.totalBound = "true";
        unitPriceInput.dataset.totalBound = "true";
        qtyInput.addEventListener("input", updateTotal);
        unitPriceInput.addEventListener("input", updateTotal);
      }

      updateNet();
      updateTotal();
    }

    bindCalculations();

    document.body.addEventListener("htmx:afterSwap", function (event) {
      if (event.target && event.target.id === "weights-block") {
        bindCalculations();
      }
    });
  })();
</script>
{% endblock %}

