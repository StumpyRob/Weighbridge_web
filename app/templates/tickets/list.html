{% extends "base.html" %}

{% block title %}Tickets | Weighbridge Web{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Tickets</h1>
    <p class="muted">Filter and review ticket activity.</p>
  </div>
  <div>
    <form method="post" action="/tickets/new/quick">
      <button class="button" type="submit">New Ticket</button>
    </form>
  </div>
</div>

<form class="filters" method="get" action="/tickets">
  <div class="field">
    <label for="q">Search</label>
    <input
      type="text"
      id="q"
      name="q"
      value="{{ filters.q }}"
      placeholder="Ticket, vehicle, customer"
    />
  </div>
  <div class="field">
    <label for="status">Status</label>
    <select id="status" name="status">
      <option value="">All</option>
      <option value="OPEN" {% if filters.status == "OPEN" %}selected{% endif %}>OPEN</option>
      <option value="COMPLETE" {% if filters.status == "COMPLETE" %}selected{% endif %}>COMPLETE</option>
      <option value="VOID" {% if filters.status == "VOID" %}selected{% endif %}>VOID</option>
    </select>
  </div>
  <div class="actions">
    <button type="submit">Filter</button>
    <a class="link-button" href="/tickets">Reset</a>
  </div>
</form>

<div class="table-wrap">
  <table class="data-table tickets-table">
    <thead>
      <tr>
        <th>Ticket no</th>
        <th>Date/time</th>
        <th>Direction</th>
        <th>Transaction</th>
        <th>Customer</th>
        <th>Vehicle</th>
        <th>Product</th>
        <th class="weights-col">Gross/Tare/Net</th>
        <th>Total</th>
        <th class="status-col">Status</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          <td>
            <a
              href="/tickets/{{ row.Ticket.id }}"
              {% if row.Ticket.status and row.Ticket.status.value == "VOID" %}class="link-muted"{% endif %}
            >
              {{ row.Ticket.ticket_no }}
            </a>
          </td>
          <td>{{ row.Ticket.datetime.strftime("%d/%m/%Y %H:%M") if row.Ticket.datetime else "" }}</td>
          <td>{{ row.Ticket.direction.value if row.Ticket.direction else "" }}</td>
          <td>{{ row.Ticket.transaction_type.value if row.Ticket.transaction_type else "" }}</td>
          <td>{{ row.Customer.name if row.Customer else "" }}</td>
          <td>{{ row.Vehicle.registration if row.Vehicle else "" }}</td>
          <td>{{ row.Product.description if row.Product else "" }}</td>
          <td class="weights-col">
            {{ "{:.0f}".format(row.Ticket.gross_kg) if row.Ticket.gross_kg is not none else "&mdash;" | safe }} /
            {{ "{:.0f}".format(row.Ticket.tare_kg) if row.Ticket.tare_kg is not none else "&mdash;" | safe }} /
            {{ "{:.0f}".format(row.Ticket.net_kg) if row.Ticket.net_kg is not none else "&mdash;" | safe }}
          </td>
          <td>
            {{ "{:.2f}".format(row.Ticket.total) if row.Ticket.total is not none else "&mdash;" | safe }}
            {% if row.Ticket.dont_invoice %}
              <div class="muted">Do not invoice</div>
            {% endif %}
          </td>
          <td class="status-col">
            {% if row.Ticket.status %}
              <span class="status-text status-{{ row.Ticket.status.value | lower }}">
                {{ row.Ticket.status.value }}
              </span>
            {% endif %}
            {% if row.Invoice %}
              <a class="muted" href="/invoices/{{ row.Invoice.id }}">
                [{{ row.Invoice.invoice_no }}]
              </a>
            {% endif %}
            {% if row.Ticket.status and row.Ticket.status.value in ["COMPLETE", "VOID"] %}
              <div class="muted">Locked</div>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="10" class="empty">No tickets found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="pagination">
  <div class="muted">
    Page {{ page }} of {{ total_pages }} ({{ total_count }} tickets)
  </div>
  <div class="pager-links">
    {% if page > 1 %}
      <a href="/tickets?page={{ page - 1 }}">Previous</a>
    {% endif %}
    {% if page < total_pages %}
      <a href="/tickets?page={{ page + 1 }}">Next</a>
    {% endif %}
  </div>
</div>
{% endblock %}
