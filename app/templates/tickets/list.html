{# Ticket list is intentionally minimal (scan view).
   Extra fields belong on the ticket detail/edit page.
   Do not re-add lookups/customer/product here unless requested. #}
{% extends "base.html" %}

{% block title %}Tickets | Weighbridge Web{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Tickets</h1>
    <p class="muted">Filter and review ticket activity.</p>
  </div>
  <div>
    <form method="post" action="/tickets/new/quick">
      <button class="button" type="submit">New Ticket</button>
    </form>
  </div>
</div>

<form class="filters" method="get" action="/tickets">
  {% if filters.date_from %}
    <input type="hidden" name="date_from" value="{{ filters.date_from }}" />
  {% endif %}
  {% if filters.date_to %}
    <input type="hidden" name="date_to" value="{{ filters.date_to }}" />
  {% endif %}
  {% if filters.direction %}
    <input type="hidden" name="direction" value="{{ filters.direction }}" />
  {% endif %}
  <div class="field">
    <label for="q">Search</label>
    <input
      type="text"
      id="q"
      name="q"
      value="{{ filters.q }}"
      placeholder="Ticket, vehicle"
    />
  </div>
  <div class="field">
    <label for="status">Status</label>
    <select id="status" {% if filters.open_only %}disabled{% else %}name="status"{% endif %}>
      <option value="">All</option>
      <option value="OPEN" {% if filters.status == "OPEN" %}selected{% endif %}>OPEN</option>
      <option value="COMPLETE" {% if filters.status == "COMPLETE" %}selected{% endif %}>COMPLETE</option>
      <option value="VOID" {% if filters.status == "VOID" %}selected{% endif %}>VOID</option>
    </select>
    {% if filters.open_only %}
      <div class="muted">(Open only enabled)</div>
    {% endif %}
  </div>
  <div class="field">
    <label for="open_only">Open only</label>
    <input
      type="checkbox"
      id="open_only"
      name="open_only"
      value="1"
      {% if filters.open_only %}checked{% endif %}
    />
  </div>
  <div class="actions">
    <button type="submit">Filter</button>
    <a class="link-button" href="/tickets">Reset</a>
  </div>
</form>

<div class="table-wrap">
  <table class="data-table tickets-table">
    <thead>
      <tr>
        <th>Ticket #</th>
        <th>Date / Time</th>
        <th>Direction</th>
        <th>Vehicle</th>
        <th class="status-col">Status</th>
        <th class="weights-col">Net</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          <td>
            <a
              href="/tickets/{{ row.Ticket.id }}"
              {% if row.Ticket.status and row.Ticket.status.value == "VOID" %}class="link-muted"{% endif %}
            >
              {{ row.Ticket.ticket_no }}
            </a>
          </td>
          <td>{{ row.Ticket.datetime.strftime("%d/%m/%Y %H:%M") if row.Ticket.datetime else "" }}</td>
          <td>
            {% if row.Ticket.direction %}
              {% if row.Ticket.direction.value == "INWARD" %}IN{% elif row.Ticket.direction.value == "OUTWARD" %}OUT{% else %}{{ row.Ticket.direction.value }}{% endif %}
            {% endif %}
          </td>
          <td>
            {{ row.Vehicle.registration if row.Vehicle else "&mdash;" | safe }}
          </td>
          <td class="status-col">
            {% if row.Ticket.status %}
              <span class="status-text status-{{ row.Ticket.status.value | lower }}">
                {{ row.Ticket.status.value }}
              </span>
            {% endif %}
          </td>
          <td class="weights-col">
            {{ "{:.0f}".format(row.Ticket.net_kg) if row.Ticket.net_kg is not none else "&mdash;" | safe }}
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="6" class="empty">No tickets found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="pagination">
  <div class="muted">
    Page {{ page }} of {{ total_pages }} ({{ total_count }} tickets)
  </div>
  <div class="pager-links">
    {% if page > 1 %}
      <a href="/tickets?page={{ page - 1 }}">Previous</a>
    {% endif %}
    {% if page < total_pages %}
      <a href="/tickets?page={{ page + 1 }}">Next</a>
    {% endif %}
  </div>
</div>
{% endblock %}
